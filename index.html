<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M3U Player with Token Authentication</title>
    <!-- Shaka Player CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.9/controls.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 10px;
        }
        
        h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            color: #a0c8ff;
            font-size: 0.9rem;
        }
        
        .input-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .url-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(to right, #4a69bd, #1e3799);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: linear-gradient(to right, #5a79cd, #2e47a9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-small {
            padding: 10px;
            font-size: 0.9rem;
            background: linear-gradient(to right, #3c6382, #0a3d62);
        }
        
        .player-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        
        #video-container {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            position: relative;
            background-color: #000;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .controls {
            padding: 15px;
        }
        
        .channel-selector {
            margin-bottom: 15px;
        }
        
        .channel-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #fff;
            font-size: 0.95rem;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        
        option {
            background: #0c2461;
            color: white;
            padding: 8px;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 500;
            display: none;
            font-size: 0.9rem;
        }
        
        .status.success {
            background-color: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #2ecc71;
            display: block;
        }
        
        .status.error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
            color: #e74c3c;
            display: block;
        }
        
        .status.info {
            background-color: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.4);
            color: #3498db;
            display: block;
        }
        
        .status.warning {
            background-color: rgba(243, 156, 18, 0.2);
            border: 1px solid rgba(243, 156, 18, 0.4);
            color: #f39c12;
            display: block;
        }
        
        .channels-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .channels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .channels-header h3 {
            color: #4a9eff;
            font-size: 1.1rem;
        }
        
        .channels-count {
            background: #4a69bd;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .channel-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .channel-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .channel-logo {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            margin: 0 auto 8px;
            object-fit: cover;
            background: linear-gradient(135deg, #3c6382, #0a3d62);
        }
        
        .channel-name {
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .channel-group {
            font-size: 0.75rem;
            color: #a0c8ff;
            margin-top: 4px;
        }
        
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            margin: 15px auto;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4a9eff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .drm-badge {
            display: inline-block;
            background: rgba(155, 89, 182, 0.3);
            color: #9b59b6;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-top: 5px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .channel-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .channel-logo {
                width: 50px;
                height: 50px;
            }
        }
        
        @media (max-width: 480px) {
            .channel-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê M3U Token Player</h1>
            <p class="subtitle">Load and play token-protected M3U playlists with Widevine DRM</p>
        </header>
        
        <div class="input-section">
            <input type="text" 
                   id="m3u-url" 
                   class="url-input" 
                   value="https://converse.nathcreqtives.com/playlist.m3u?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJyZWl5aDEwMjY5NCIsImV4cCI6MTc2NTg1Njc0MH0.6hmppZKNycvU17S2latBLhBPM2wpyHgksWrWRtQp9bM"
                   placeholder="Enter M3U URL with token...">
            
            <button id="load-playlist-btn" class="btn">
                üì° Load M3U Playlist
            </button>
            
            <div class="loader" id="loader"></div>
            
            <div id="status" class="status info" style="display: block;">
                Enter your M3U URL with token and click "Load M3U Playlist" to begin.
            </div>
        </div>
        
        <div class="player-container" id="player-container">
            <div id="video-container">
                <video id="video" autoplay controls playsinline></video>
            </div>
            
            <div class="controls">
                <div class="channel-selector">
                    <div class="channel-label">Select Channel</div>
                    <select id="channel-select">
                        <option value="">-- Select a channel --</option>
                    </select>
                </div>
                
                <button id="play-btn" class="btn">
                    ‚ñ∂ Play Channel
                </button>
                
                <div id="player-status" class="status"></div>
            </div>
        </div>
        
        <div class="channels-panel" id="channels-panel">
            <div class="channels-header">
                <h3>üì∫ Available Channels</h3>
                <span class="channels-count" id="channels-count">0</span>
            </div>
            <div class="channel-grid" id="channels-grid">
                <!-- Channels will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Shaka Player library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.9/shaka-player.ui.min.js"></script>
    
    <script>
        // Global variables
        let shakaPlayer = null;
        let channels = [];
        let currentM3UUrl = '';
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Shaka Player
            initShakaPlayer();
            
            // Setup event listeners
            document.getElementById('load-playlist-btn').addEventListener('click', loadPlaylist);
            document.getElementById('play-btn').addEventListener('click', playSelectedChannel);
            
            // Auto-load the provided URL
            const m3uUrl = document.getElementById('m3u-url').value;
            if (m3uUrl) {
                setTimeout(() => {
                    loadPlaylist();
                }, 500);
            }
        });
        
        // Initialize Shaka Player
        function initShakaPlayer() {
            const video = document.getElementById('video');
            
            // Check if browser supports Shaka Player
            if (!shaka.Player.isBrowserSupported()) {
                showStatus('Your browser does not support Shaka Player. Please use Chrome, Firefox, or Edge.', 'error');
                return;
            }
            
            // Create Shaka Player instance
            shakaPlayer = new shaka.Player(video);
            
            // Configure player
            shakaPlayer.configure({
                streaming: {
                    bufferingGoal: 30,
                    rebufferingGoal: 2,
                    bufferBehind: 30
                }
            });
            
            // Set up UI
            const ui = new shaka.ui.Overlay(shakaPlayer, video, video.parentElement);
            
            // Error handling
            shakaPlayer.addEventListener('error', (event) => {
                console.error('Shaka Player Error:', event.detail);
                showPlayerStatus(`Player Error: ${event.detail.message}`, 'error');
            });
        }
        
        // Load M3U playlist from URL
        async function loadPlaylist() {
            const m3uUrl = document.getElementById('m3u-url').value.trim();
            
            if (!m3uUrl) {
                showStatus('Please enter a valid M3U URL', 'error');
                return;
            }
            
            currentM3UUrl = m3uUrl;
            
            // Show loading state
            const loadBtn = document.getElementById('load-playlist-btn');
            const loader = document.getElementById('loader');
            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ Loading...';
            loader.style.display = 'block';
            showStatus('Fetching M3U playlist...', 'info');
            
            try {
                // Fetch the M3U playlist
                const response = await fetch(m3uUrl, {
                    headers: {
                        'Accept': 'application/vnd.apple.mpegurl, application/x-mpegurl, audio/x-mpegurl, video/x-mpegurl'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const m3uContent = await response.text();
                
                if (!m3uContent.includes('#EXTM3U')) {
                    throw new Error('Invalid M3U format');
                }
                
                // Parse the M3U content
                channels = parseM3U(m3uContent);
                
                if (channels.length === 0) {
                    throw new Error('No channels found in playlist');
                }
                
                // Show success and populate channels
                showStatus(`Successfully loaded ${channels.length} channels`, 'success');
                populateChannels();
                
                // Show player and channels panel
                document.getElementById('player-container').style.display = 'block';
                document.getElementById('channels-panel').style.display = 'block';
                
                // Auto-select first channel
                if (channels.length > 0) {
                    document.getElementById('channel-select').value = '0';
                    showPlayerStatus(`Ready to play. ${channels.length} channels loaded.`, 'info');
                }
                
            } catch (error) {
                console.error('Error loading M3U:', error);
                showStatus(`Failed to load playlist: ${error.message}`, 'error');
                
                // Try alternative method - maybe the URL returns a redirect or different content type
                showStatus('Trying alternative method...', 'warning');
                
                // Try with CORS proxy as fallback
                try {
                    const corsProxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(m3uUrl)}`;
                    const proxyResponse = await fetch(corsProxyUrl);
                    const m3uContent = await proxyResponse.text();
                    
                    if (m3uContent.includes('#EXTM3U')) {
                        channels = parseM3U(m3uContent);
                        showStatus(`Loaded ${channels.length} channels via proxy`, 'success');
                        populateChannels();
                        document.getElementById('player-container').style.display = 'block';
                        document.getElementById('channels-panel').style.display = 'block';
                    } else {
                        throw new Error('Invalid M3U content via proxy');
                    }
                } catch (proxyError) {
                    showStatus(`Proxy also failed: ${proxyError.message}`, 'error');
                }
            } finally {
                // Reset button state
                loadBtn.disabled = false;
                loadBtn.textContent = 'üì° Load M3U Playlist';
                loader.style.display = 'none';
            }
        }
        
        // Parse M3U content
        function parseM3U(content) {
            const channels = [];
            const lines = content.split('\n');
            let currentChannel = null;
            let currentLicenseKey = '';
            let currentManifestType = 'mpd';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    // New channel entry
                    currentChannel = {};
                    
                    // Extract channel name (after the last comma)
                    const nameMatch = line.match(/,(.+)$/);
                    if (nameMatch) {
                        currentChannel.name = nameMatch[1].trim();
                    } else {
                        currentChannel.name = `Channel ${channels.length + 1}`;
                    }
                    
                    // Extract tvg-id
                    const idMatch = line.match(/tvg-id="([^"]+)"/);
                    currentChannel.id = idMatch ? idMatch[1] : '';
                    
                    // Extract logo
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                    currentChannel.logo = logoMatch ? logoMatch[1] : '';
                    
                    // Extract group
                    const groupMatch = line.match(/group-title="([^"]+)"/);
                    currentChannel.group = groupMatch ? groupMatch[1] : 'Uncategorized';
                    
                    // Reset DRM properties for new channel
                    currentLicenseKey = '';
                    currentManifestType = 'mpd';
                    
                } else if (line.startsWith('#KODIPROP:')) {
                    // Parse KODIPROP properties
                    if (line.includes('inputstream.adaptive.license_key=')) {
                        const match = line.match(/license_key=(.+)$/);
                        if (match) {
                            currentLicenseKey = match[1];
                        }
                    } else if (line.includes('inputstream.adaptive.manifest_type=')) {
                        const match = line.match(/manifest_type=(\w+)/);
                        if (match) {
                            currentManifestType = match[1];
                        }
                    }
                    
                } else if (line.startsWith('http')) {
                    // This is a stream URL
                    if (currentChannel) {
                        currentChannel.url = line;
                        currentChannel.licenseKey = currentLicenseKey;
                        currentChannel.manifestType = currentManifestType;
                        currentChannel.hasDRM = !!currentLicenseKey;
                        
                        channels.push({...currentChannel});
                        currentChannel = null;
                    }
                }
            }
            
            return channels;
        }
        
        // Populate channels in dropdown and grid
        function populateChannels() {
            const select = document.getElementById('channel-select');
            const grid = document.getElementById('channels-grid');
            const count = document.getElementById('channels-count');
            
            // Clear existing
            select.innerHTML = '<option value="">-- Select a channel --</option>';
            grid.innerHTML = '';
            
            // Update count
            count.textContent = channels.length;
            
            // Populate dropdown and grid
            channels.forEach((channel, index) => {
                // Add to dropdown
                const option = document.createElement('option');
                option.value = index;
                option.textContent = channel.name;
                select.appendChild(option);
                
                // Create channel card
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.dataset.index = index;
                
                // Determine logo URL
                let logoUrl = channel.logo;
                if (!logoUrl || logoUrl.includes('undefined')) {
                    // Generate a placeholder based on channel name
                    const colors = ['#4a69bd', '#e55039', '#f6b93b', '#78e08f', '#8e44ad'];
                    const color = colors[index % colors.length];
                    const initials = channel.name.substring(0, 2).toUpperCase();
                    logoUrl = `https://via.placeholder.com/60/${color.replace('#', '')}/ffffff?text=${encodeURIComponent(initials)}`;
                }
                
                card.innerHTML = `
                    <img src="${logoUrl}" 
                         class="channel-logo" 
                         onerror="this.src='https://via.placeholder.com/60/4a69bd/ffffff?text=TV'">
                    <div class="channel-name">${channel.name}</div>
                    <div class="channel-group">${channel.group}</div>
                    ${channel.hasDRM ? '<div class="drm-badge">DRM</div>' : ''}
                `;
                
                // Add click event
                card.addEventListener('click', () => {
                    select.value = index;
                    playSelectedChannel();
                });
                
                grid.appendChild(card);
            });
        }
        
        // Play selected channel
        async function playSelectedChannel() {
            const select = document.getElementById('channel-select');
            const selectedIndex = select.value;
            
            if (!selectedIndex) {
                showPlayerStatus('Please select a channel first', 'warning');
                return;
            }
            
            const channel = channels[selectedIndex];
            const playBtn = document.getElementById('play-btn');
            const playerStatus = document.getElementById('player-status');
            
            // Show loading state
            playBtn.disabled = true;
            playBtn.textContent = '‚è≥ Loading...';
            playerStatus.className = 'status info';
            playerStatus.textContent = `Loading ${channel.name}...`;
            playerStatus.style.display = 'block';
            
            try {
                console.log('Playing channel:', channel);
                
                // Configure DRM if channel has it
                if (channel.hasDRM && channel.licenseKey) {
                    shakaPlayer.configure({
                        drm: {
                            servers: {
                                'com.widevine.alpha': channel.licenseKey
                            }
                        }
                    });
                    console.log('DRM configured with license key:', channel.licenseKey);
                } else {
                    // Clear DRM configuration
                    shakaPlayer.configure({
                        drm: {
                            servers: {}
                        }
                    });
                }
                
                // Load the manifest
                await shakaPlayer.load(channel.url);
                
                // Success
                showPlayerStatus(`Now playing: ${channel.name}`, 'success');
                
                // Try to auto-play (muted for browser policies)
                const video = document.getElementById('video');
                video.muted = true;
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        showPlayerStatus('Tap the play button to start', 'info');
                    });
                }
                
            } catch (error) {
                console.error('Playback error:', error);
                
                // Try alternative approach
                if (error.code === shaka.util.Error.Code.UNABLE_TO_GUESS_MANIFEST_TYPE) {
                    showPlayerStatus('Trying alternative playback method...', 'warning');
                    
                    // Try with explicit configuration
                    try {
                        const playerConfig = channel.hasDRM ? {
                            drm: {
                                servers: {
                                    'com.widevine.alpha': channel.licenseKey
                                }
                            }
                        } : {};
                        
                        await shakaPlayer.load(channel.url, null, playerConfig);
                        showPlayerStatus(`Now playing: ${channel.name}`, 'success');
                    } catch (retryError) {
                        showPlayerStatus(`Playback failed: ${retryError.message}`, 'error');
                    }
                } else {
                    showPlayerStatus(`Error: ${error.message}`, 'error');
                }
            } finally {
                // Reset button state
                playBtn.disabled = false;
                playBtn.textContent = '‚ñ∂ Play Channel';
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    if (status.textContent === message) {
                        status.style.display = 'none';
                    }
                }, 3000);
            }
        }
        
        // Show player status message
        function showPlayerStatus(message, type) {
            const status = document.getElementById('player-status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    if (status.textContent === message) {
                        status.style.display = 'none';
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>
