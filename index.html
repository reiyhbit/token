<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPTV Player | Converge & Cignal</title>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.16.9/dist/shaka-player.ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/shaka-player@4.16.9/dist/controls.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #0f0f0f;
            --card-bg: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #374151;
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --converge-color: #f093fb;
            --cignal-color: #4facfe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .player-wrapper {
            flex: 1;
            background: var(--card-bg);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin: 1rem;
            display: flex;
            flex-direction: column;
        }

        #video-container {
            width: 100%;
            background: #000;
            position: relative;
            flex: 1;
        }

        #video {
            width: 100%;
            height: 100%;
            display: block;
        }

        #channel-name-display {
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }

        .controls-panel {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1rem;
            padding: 1rem;
        }

        @media (max-width: 1024px) {
            .controls-panel {
                grid-template-columns: 1fr;
            }
        }

        .playlist-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .channels-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .input-mode-switcher {
            display: flex;
            background: #2d2d2d;
            border-radius: 0.5rem;
            padding: 0.25rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-mode-switcher::before {
            content: '';
            position: absolute;
            top: 0.25rem;
            left: var(--slider-left, 0);
            width: var(--slider-width, 50%);
            height: calc(100% - 0.5rem);
            background: var(--primary-color);
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }

        .input-mode-switcher button {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            z-index: 1;
            transition: color 0.2s;
        }

        .input-mode-switcher button.active {
            color: var(--text-primary);
        }

        .playlist-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .playlist-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #converge-playlist-btn {
            background: linear-gradient(135deg, var(--converge-color) 0%, #f5576c 100%);
            color: white;
        }

        #cignal-playlist-btn {
            background: linear-gradient(135deg, var(--cignal-color) 0%, #00f2fe 100%);
            color: white;
        }

        .playlist-btn.active {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .playlist-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .channel-item {
            padding: 0.75rem 1rem;
            background: #2d2d2d;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid transparent;
        }

        .channel-item:hover {
            background: #3a3a3a;
            border-color: var(--primary-color);
        }

        .channel-item.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border-color: var(--primary-color);
        }

        .channel-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .channel-info {
            flex: 1;
            min-width: 0;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-group {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .drm-badge {
            background: var(--warning-color);
            color: black;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: bold;
            margin-left: 0.25rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-panel {
            background: #2d2d2d;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .stats-label {
            color: var(--text-secondary);
        }

        .stats-value {
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, monospace;
        }

        .error-message {
            display: none;
            background: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem;
            text-align: center;
        }

        .channel-nav {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .nav-btn {
            flex: 1;
            padding: 0.75rem;
            background: #2d2d2d;
            border: none;
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: #3a3a3a;
        }

        #prev-channel-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #next-channel-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .playback-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #2d2d2d;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .playback-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--error-color);
        }

        .toast.warning {
            background: var(--warning-color);
        }

        .toast.info {
            background: var(--primary-color);
        }

        .footer {
            text-align: center;
            padding: 1.5rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .channel-count {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .auto-load-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 1002;
            text-align: center;
            border: 1px solid var(--primary-color);
        }

        .auto-load-indicator .spinner {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">IPTV Player</div>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                <span>Converge & Cignal Playlists</span>
            </div>
        </header>

        <div class="player-wrapper">
            <div id="video-container" data-shaka-player-container>
                <video id="video" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225' viewBox='0 0 400 225'%3E%3Crect width='400' height='225' fill='%231a1a1a'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='24' fill='%23ffffff' text-anchor='middle' dy='.3em'%3EIPTV Player%3C/text%3E%3C/svg%3E" 
                       data-shaka-player autoplay playsinline controls></video>
            </div>
            <h2 id="channel-name-display">Select a playlist to start</h2>
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner"></div>
                <p>Loading stream...</p>
            </div>
            <div class="stats-panel" id="stats-panel">
                <div class="stats-row">
                    <span class="stats-label">Playback Method:</span>
                    <span class="stats-value" id="playback-method">Not Playing</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Buffer Health:</span>
                    <span class="stats-value" id="buffer-health">0s</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Bitrate:</span>
                    <span class="stats-value" id="current-bitrate">0 kbps</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Resolution:</span>
                    <span class="stats-value" id="current-resolution">N/A</span>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="playlist-card">
                <h2 style="margin-bottom: 1rem; display: flex; align-items: center;">
                    Playlists
                    <span class="channel-count" id="playlist-count">0</span>
                </h2>
                
                <div class="playlist-buttons">
                    <button id="converge-playlist-btn" class="playlist-btn active">Converge</button>
                    <button id="cignal-playlist-btn" class="playlist-btn">Cignal</button>
                </div>

                <div class="channel-nav">
                    <button id="prev-channel-btn" class="nav-btn">
                        ← Previous
                    </button>
                    <button id="next-channel-btn" class="nav-btn">
                        Next →
                    </button>
                </div>

                <div class="playback-info">
                    <span>Status:</span>
                    <span class="playback-badge" id="status-badge">Idle</span>
                </div>
            </div>

            <div class="channels-card">
                <h2 style="margin-bottom: 1rem; display: flex; align-items: center;">
                    Channels
                    <span class="channel-count" id="channel-count">0</span>
                </h2>
                
                <div id="channel-list" class="channel-list">
                    <div class="channel-item" style="text-align: center; justify-content: center; opacity: 0.7;">
                        Select a playlist to view channels
                    </div>
                </div>
            </div>
        </div>

        <div class="error-message" id="error-message"></div>

        <footer class="footer">
            <p>&copy; 2025 IPTV Player. Powered by Shaka Player (4.16.9)</p>
        </footer>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Seamless IPTV Player for Converge & Cignal
        let player;
        let currentPlaylist = 'converge';
        let convergeChannels = [];
        let cignalChannels = [];
        let currentChannels = [];
        let currentChannelIndex = -1;
        let isLoading = false;
        
        // Configuration - Cignal auto-load and auto-play
        const AUTO_LOAD_PLAYLIST = 'cignal';
        const AUTO_PLAY_FIRST_CHANNEL = true;
        
        // Playlist URLs
        const PLAYLIST_URLS = {
            converge: 'https://converse.nathcreqtives.com/playlist.m3u?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJyZWl5aDEwMjY5NCIsImV4cCI6MTc2NTg1Njc0MH0.6hmppZKNycvU17S2latBLhBPM2wpyHgksWrWRtQp9bM',
            cignal: 'https://reiyhbit.github.io/iptv/playlist.m3u'
        };
        
        // DRM Configuration
        const DRM_CONFIG = {
            converge: {
                servers: {
                    'com.widevine.alpha': 'https://key.nathcreqtives.com/widevine/?deviceId=02:00:00:00:00:00'
                },
                advanced: {
                    'com.widevine.alpha': {
                        videoRobustness: 'SW_SECURE_CRYPTO',
                        audioRobustness: 'SW_SECURE_CRYPTO'
                    }
                }
            },
            cignal: {
                servers: {},
                advanced: {}
            }
        };
        
        // DOM Elements
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('video-container');
        const errorDisplay = document.getElementById('error-message');
        const channelNameDisplay = document.getElementById('channel-name-display');
        const channelList = document.getElementById('channel-list');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statsPanel = document.getElementById('stats-panel');
        const toast = document.getElementById('toast');
        
        // Initialize Shaka Player - ONE TIME SETUP
        function initPlayer() {
            shaka.polyfill.installAll();
            
            if (!shaka.Player.isBrowserSupported()) {
                showError('Your browser does not support Shaka Player.');
                return false;
            }
            
            try {
                // Create player instance - ONE TIME
                player = new shaka.Player();
                player.attach(video);
                
                // Configure with default settings
                player.configure({
                    streaming: {
                        bufferingGoal: 30,
                        rebufferingGoal: 15,
                        bufferBehind: 30,
                        preferNativeHls: true,
                        useNativeHlsForFairPlay: true,
                        lowLatencyMode: true
                    }
                });
                
                // Event listeners
                player.addEventListener('error', onPlayerError);
                player.addEventListener('loading', () => {
                    showLoading(true, 'Loading stream...');
                });
                
                player.addEventListener('loaded', () => {
                    showLoading(false);
                    updateStats();
                    statsPanel.style.display = 'block';
                });
                
                player.addEventListener('buffering', (event) => {
                    if (!event.buffering) {
                        updateStats();
                    }
                });
                
                // Update stats periodically
                setInterval(updateStats, 1000);
                
                return true;
            } catch (error) {
                console.error('Player initialization error:', error);
                showError(`Player initialization failed: ${error.message}`);
                return false;
            }
        }
        
        // Enhanced M3U parsing - SIMPLE AND ROBUST
        function parseM3U(data, playlistType) {
            const lines = data.split('\n');
            const channels = [];
            let currentChannel = {};
            let currentKeys = {};
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('#EXTM3U')) {
                    continue;
                }
                
                if (trimmedLine.startsWith('#EXTINF:')) {
                    const info = trimmedLine.split(/,(.*)/s);
                    const params = info[0].split(' ');
                    currentChannel.name = info[1]?.trim() || 'Unknown Channel';
                    
                    // Parse group title
                    params.forEach(param => {
                        if (param.includes('group-title=')) {
                            currentChannel.group = param.split('=')[1]?.replace(/"/g, '');
                        }
                    });
                    
                    if (!currentChannel.group) {
                        currentChannel.group = playlistType === 'converge' ? 'Converge TV' : 'Cignal TV';
                    }
                    
                } else if (trimmedLine.startsWith('#KODIPROP:inputstream.adaptive.license_type=')) {
                    const licenseType = trimmedLine.substring('#KODIPROP:inputstream.adaptive.license_type='.length);
                    if (licenseType.trim().toLowerCase() === 'clearkey') {
                        currentKeys.type = 'clearkey';
                    }
                    
                } else if (trimmedLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    const licenseKey = trimmedLine.substring('#KODIPROP:inputstream.adaptive.license_key='.length);
                    
                    if (currentKeys.type === 'clearkey') {
                        // Parse ClearKey format: key_id:key
                        const parts = licenseKey.split(':');
                        if (parts.length === 2) {
                            currentKeys.keyId = parts[0];
                            currentKeys.key = parts[1];
                        }
                    } else {
                        // Other license types
                        currentChannel.licenseKey = licenseKey;
                    }
                    
                } else if (trimmedLine && !trimmedLine.startsWith('#')) {
                    // This is the stream URL
                    currentChannel.url = trimmedLine;
                    
                    // Add ClearKey data if available
                    if (currentKeys.keyId && currentKeys.key) {
                        currentChannel.clearkey = {
                            keyId: currentKeys.keyId,
                            key: currentKeys.key
                        };
                    }
                    
                    // Only add if it's a valid URL
                    if (currentChannel.url.startsWith('http')) {
                        channels.push({...currentChannel});
                    }
                    
                    // Reset for next channel
                    currentChannel = {};
                    currentKeys = {};
                }
            }
            
            return channels;
        }
        
        // Load playlist - SIMPLE APPROACH
        async function loadPlaylist(playlistType) {
            if (isLoading) return;
            
            isLoading = true;
            showToast(`Loading ${playlistType} playlist...`, 'info');
            showLoading(true, `Loading ${playlistType} playlist...`);
            
            try {
                const response = await fetch(PLAYLIST_URLS[playlistType]);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                const channels = parseM3U(text, playlistType);
                
                if (channels.length === 0) {
                    showToast(`No channels found in ${playlistType} playlist`, 'warning');
                    return;
                }
                
                // Store channels
                if (playlistType === 'converge') {
                    convergeChannels = channels;
                } else {
                    cignalChannels = channels;
                }
                
                currentPlaylist = playlistType;
                currentChannels = channels;
                
                // Update UI
                updateChannelListUI();
                showToast(`${playlistType.toUpperCase()} playlist loaded with ${channels.length} channels`, 'success');
                
                // Auto-play first channel
                if (AUTO_PLAY_FIRST_CHANNEL && channels.length > 0) {
                    setTimeout(() => {
                        playChannel(0);
                    }, 500);
                }
                
            } catch (error) {
                console.error(`Error loading ${playlistType} playlist:`, error);
                showToast(`Failed to load ${playlistType} playlist: ${error.message}`, 'error');
                
                // Fallback to sample data
                useFallbackChannels(playlistType);
                
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }
        
        // Fallback channels
        function useFallbackChannels(playlistType) {
            const fallbackChannels = [
                {
                    name: 'Sample Stream 1',
                    url: 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8',
                    group: 'Fallback'
                },
                {
                    name: 'Sample Stream 2',
                    url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8',
                    group: 'Fallback'
                }
            ];
            
            if (playlistType === 'converge') {
                convergeChannels = fallbackChannels;
            } else {
                cignalChannels = fallbackChannels;
            }
            
            currentPlaylist = playlistType;
            currentChannels = fallbackChannels;
            
            updateChannelListUI();
            showToast(`Using fallback streams for ${playlistType}`, 'warning');
            
            if (fallbackChannels.length > 0) {
                setTimeout(() => {
                    playChannel(0);
                }, 500);
            }
        }
        
        // Play channel - SEAMLESS APPROACH
        async function playChannel(index) {
            if (currentChannels.length === 0 || index < 0 || index >= currentChannels.length) {
                return;
            }
            
            const channel = currentChannels[index];
            currentChannelIndex = index;
            
            showLoading(true, `Loading ${channel.name}...`);
            showToast(`Loading: ${channel.name}`, 'info');
            
            try {
                // Clear previous error
                hideError();
                
                // Configure player based on playlist type
                const config = {
                    streaming: {
                        bufferingGoal: 30,
                        rebufferingGoal: 15,
                        bufferBehind: 30,
                        preferNativeHls: true,
                        useNativeHlsForFairPlay: true,
                        lowLatencyMode: true
                    }
                };
                
                if (currentPlaylist === 'converge') {
                    // Configure for Widevine DRM
                    config.drm = {
                        servers: DRM_CONFIG.converge.servers,
                        advanced: DRM_CONFIG.converge.advanced,
                        clearKeys: {}
                    };
                } else if (currentPlaylist === 'cignal' && channel.clearkey) {
                    // Configure for ClearKey DRM
                    config.drm = {
                        servers: {},
                        advanced: {},
                        clearKeys: {
                            [channel.clearkey.keyId]: channel.clearkey.key
                        }
                    };
                } else {
                    // No DRM
                    config.drm = {
                        servers: {},
                        advanced: {},
                        clearKeys: {}
                    };
                }
                
                // RE-CONFIGURE the player (not destroy/recreate)
                player.configure(config);
                
                // Load the stream
                await player.load(channel.url);
                
                // Update UI
                channelNameDisplay.textContent = channel.name;
                updatePlaybackMethod(currentPlaylist === 'converge' ? 'Widevine DRM' : 
                                    (channel.clearkey ? 'ClearKey DRM' : 'No DRM'));
                showToast(`Now playing: ${channel.name}`, 'success');
                
                // Update active channel in list
                updateActiveChannel();
                
            } catch (error) {
                console.error('Error playing channel:', error);
                showToast(`Failed to play ${channel.name}: ${error.message}`, 'error');
                
                // Try fallback playback
                tryFallbackPlayback(channel.url, channel.name);
                
            } finally {
                showLoading(false);
            }
        }
        
        // Fallback playback
        async function tryFallbackPlayback(streamUrl, channelName) {
            try {
                showToast('Trying fallback playback...', 'warning');
                
                // Try without DRM
                player.configure({
                    drm: {
                        servers: {},
                        advanced: {},
                        clearKeys: {}
                    }
                });
                
                await player.load(streamUrl);
                showToast(`Playing ${channelName} (fallback mode)`, 'success');
                
            } catch (fallbackError) {
                console.error('Fallback playback failed:', fallbackError);
                showError(`All playback methods failed for ${channelName}`);
            }
        }
        
        // Update channel list UI
        function updateChannelListUI() {
            channelList.innerHTML = '';
            
            if (currentChannels.length === 0) {
                channelList.innerHTML = `
                    <div class="channel-item" style="text-align: center; justify-content: center; opacity: 0.7;">
                        No channels available
                    </div>
                `;
                document.getElementById('channel-count').textContent = '0';
                return;
            }
            
            document.getElementById('channel-count').textContent = currentChannels.length;
            
            currentChannels.forEach((channel, index) => {
                const channelElement = document.createElement('div');
                channelElement.className = 'channel-item';
                if (index === currentChannelIndex) {
                    channelElement.classList.add('active');
                }
                
                // Get logo color based on channel name
                const logoColor = getLogoColor(channel.name);
                const logoLetter = channel.name.charAt(0).toUpperCase();
                
                // DRM indicator
                const drmIndicator = (currentPlaylist === 'cignal' && channel.clearkey) ? 
                    '<span class="drm-badge">DRM</span>' : '';
                
                channelElement.innerHTML = `
                    <div class="channel-logo" style="background: ${logoColor}">
                        ${logoLetter}
                    </div>
                    <div class="channel-info">
                        <div class="channel-name">${channel.name}${drmIndicator}</div>
                        <div class="channel-group">${channel.group}</div>
                    </div>
                `;
                
                channelElement.addEventListener('click', () => {
                    playChannel(index);
                });
                
                channelList.appendChild(channelElement);
            });
        }
        
        // Update active channel in list
        function updateActiveChannel() {
            document.querySelectorAll('.channel-item').forEach((item, index) => {
                if (index === currentChannelIndex) {
                    item.classList.add('active');
                    // Scroll into view
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // Next channel
        function nextChannel() {
            if (currentChannels.length === 0) return;
            
            const nextIndex = (currentChannelIndex + 1) % currentChannels.length;
            playChannel(nextIndex);
        }
        
        // Previous channel
        function prevChannel() {
            if (currentChannels.length === 0) return;
            
            const prevIndex = (currentChannelIndex - 1 + currentChannels.length) % currentChannels.length;
            playChannel(prevIndex);
        }
        
        // Get logo color
        function getLogoColor(channelName) {
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                '#fa709a', '#fee140'
            ];
            
            let hash = 0;
            for (let i = 0; i < channelName.length; i++) {
                hash = channelName.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        // Show/hide loading
        function showLoading(show, message = 'Loading...') {
            if (show) {
                loadingSpinner.style.display = 'block';
                loadingSpinner.querySelector('p').textContent = message;
            } else {
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Show toast
        function showToast(message, type = 'success', duration = 3000) {
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Show error
        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            
            setTimeout(() => {
                hideError();
            }, 5000);
        }
        
        // Hide error
        function hideError() {
            errorDisplay.style.display = 'none';
        }
        
        // Update playback method display
        function updatePlaybackMethod(method) {
            document.getElementById('playback-method').textContent = method;
            document.getElementById('status-badge').textContent = method;
        }
        
        // Update statistics
        function updateStats() {
            if (!player) return;
            
            try {
                const bufferHealth = player.getBufferHealth();
                const activeTracks = player.getVariantTracks().filter(track => track.active);
                
                document.getElementById('buffer-health').textContent = `${bufferHealth.toFixed(1)}s`;
                
                if (activeTracks.length > 0) {
                    const track = activeTracks[0];
                    const bitrate = Math.round(track.bandwidth / 1000);
                    const resolution = `${track.width || 'N/A'}x${track.height || 'N/A'}`;
                    
                    document.getElementById('current-bitrate').textContent = `${bitrate} kbps`;
                    document.getElementById('current-resolution').textContent = resolution;
                }
            } catch (error) {
                // Ignore stats errors
            }
        }
        
        // Handle player errors
        function onPlayerError(event) {
            const error = event.detail;
            console.error('Player error:', error);
            
            // If Widevine fails, try without DRM
            if (currentPlaylist === 'converge') {
                showToast('Widevine failed, trying without DRM...', 'warning');
                
                setTimeout(() => {
                    if (currentChannelIndex >= 0 && currentChannels.length > 0) {
                        const channel = currentChannels[currentChannelIndex];
                        tryFallbackPlayback(channel.url, channel.name);
                    }
                }, 1000);
            }
        }
        
        // Auto-load functionality
        function initAutoLoad() {
            showToast('Auto-loading Cignal playlist...', 'info', 2000);
            
            // Load Cignal playlist first
            setTimeout(() => {
                document.getElementById('cignal-playlist-btn').click();
            }, 1000);
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize player
            initPlayer();
            
            // Setup event listeners
            document.getElementById('converge-playlist-btn').addEventListener('click', () => {
                document.querySelectorAll('.playlist-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('converge-playlist-btn').classList.add('active');
                
                if (convergeChannels.length === 0) {
                    loadPlaylist('converge');
                } else {
                    currentPlaylist = 'converge';
                    currentChannels = convergeChannels;
                    updateChannelListUI();
                    showToast('Converge playlist ready', 'info');
                    
                    if (currentChannels.length > 0 && currentChannelIndex === -1) {
                        playChannel(0);
                    }
                }
            });
            
            document.getElementById('cignal-playlist-btn').addEventListener('click', () => {
                document.querySelectorAll('.playlist-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('cignal-playlist-btn').classList.add('active');
                
                if (cignalChannels.length === 0) {
                    loadPlaylist('cignal');
                } else {
                    currentPlaylist = 'cignal';
                    currentChannels = cignalChannels;
                    updateChannelListUI();
                    showToast('Cignal playlist ready', 'info');
                    
                    if (currentChannels.length > 0 && currentChannelIndex === -1) {
                        playChannel(0);
                    }
                }
            });
            
            document.getElementById('prev-channel-btn').addEventListener('click', prevChannel);
            document.getElementById('next-channel-btn').addEventListener('click', nextChannel);
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                switch(e.key) {
                    case 'ArrowRight':
                        e.preventDefault();
                        nextChannel();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        prevChannel();
                        break;
                    case ' ':
                        e.preventDefault();
                        if (video.paused) {
                            video.play();
                        } else {
                            video.pause();
                        }
                        break;
                }
            });
            
            // Start auto-load
            initAutoLoad();
        });
    </script>
</body>
</html>
